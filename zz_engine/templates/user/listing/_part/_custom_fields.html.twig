<script>
    let customFields = {};
    customFields.loadedCategory = null;
    customFields.values = [];

    customFields.loadFromBackend = function() {
        let listingId = null | {{ listing.id | default('null') }};
        let categoryId = parseInt($('.formCategory').val());
        customFields.loadedCategory = categoryId;
        $.get(Routing.generate('app_listing_get_custom_fields', {listingId: listingId, categoryId: categoryId}), function (html) {
            $('.formCustomFieldList').html(html);

            $('.formCustomFieldList').find('[name^="listing[customFieldList]"]').each(function(){
                let $input = $(this);

                if (customFields.values[$input.attr('name')] && customFields.values[$input.attr('name')].trim() !== '')  {
                    $input.val(customFields.values[$input.attr('name')]);
                }
            });
        });
    };

    $('.formCategory').on('change', function () {
        if (customFields.loadedCategory === parseInt($('.formCategory').val())){
            return;
        }

        $('.formCustomFieldList').find('[name^="listing[customFieldList]"]').each(function(){
            let $input = $(this);

            if ($input.val().trim() === ''){
                return;
            }

            customFields.values[$input.attr('name')] = $input.val();
        });

        customFields.loadFromBackend();
    });
    
    if ($('.formCustomFieldList').find('.form-group').length < 1) {
        customFields.loadFromBackend();
    }

</script>
