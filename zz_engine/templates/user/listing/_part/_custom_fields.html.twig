<script>
    let customFields = {};
    customFields.loadedCategory = null;
    customFields.formArray = [];

    customFields.loadFromBackend = function() {
        let listingId = null | {{ listing.id | default('null') }};
        let categoryId = parseInt($('.formCategory').val());
        customFields.loadedCategory = categoryId;
        $.get(Routing.generate('app_listing_get_custom_fields', {listingId: listingId, categoryId: categoryId}), function (html) {
            let $formCustomFieldList = $('.formCustomFieldList');
            $formCustomFieldList.html(html);
            $formCustomFieldList.find('[name^="listing[customFieldList]"]').each(function(){
                let $input = $(this);
                let formSerializedElement = customFields.formArray[$input.attr('name')];
                if (formSerializedElement && formSerializedElement.value.trim() !== '')  {
                    $input.val(formSerializedElement.value);
                }
            });
        });
    };

    customFields.getFormArray = function () {
        let result = [];
        $('.formCategory').parents('form').serializeArray().forEach(function (el) {
            result[el.name] = el;
        });

        return result;
    };

    $('.formCategory').on('change', function () {
        if (customFields.loadedCategory === parseInt($('.formCategory').val())){
            return;
        }

        customFields.formArray = $.extend({}, customFields.formArray, customFields.getFormArray());
        customFields.loadFromBackend();
    });
    
    if ($('.formCustomFieldList').find('.form-group').length < 1) {
        customFields.loadFromBackend();
    }

</script>
